package de.b1acksheep.bookexploitquickfix;

import de.b1acksheep.bookexploitquickfix.listener.InventoryListener;
import de.b1acksheep.bookexploitquickfix.model.ExploitBook;
import org.bukkit.ChatColor;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;

import javax.persistence.PersistenceException;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Created by B1acksheep on 12.04.15.
 * Project: BookExploitQuickFix
 * Package: de.b1acksheep
 */
public class BookExploitQuickFixPluign extends JavaPlugin {

    private static Plugin instance;

    public static Plugin getInstance() {
        return instance;
    }

    public void setInstance(BookExploitQuickFixPluign instance) {
        BookExploitQuickFixPluign.instance = instance;
    }

    @Override
    public void onEnable() {
        super.onEnable();
        this.setInstance(this);

        this.setupDatabase();

        this.registerListener();
    }

    private void registerListener() {
        getServer().getPluginManager().registerEvents(new InventoryListener(this), this);
    }

    public String getPrefix() {
        return ChatColor.GRAY + "[" + ChatColor.RED + "ExploitFix" + ChatColor.GRAY + "]" +
                " " + ChatColor.RESET;
    }

    private void setupDatabase() {
        try {
            getDatabase().find(ExploitBook.class).findRowCount();
        } catch (PersistenceException e) {
            log(Level.INFO, "Installing database for " + getDescription().getName() + " due to first time usage");
            installDDL();
        }
    }

    @Override
    public List<Class<?>> getDatabaseClasses() {
        List<Class<?>> list = new ArrayList<Class<?>>();
        list.add(ExploitBook.class);
        return list;
    }

    public void log(Level level, String message) {
        Logger.getLogger("Minecraft").log(
                level,
                ChatColor.stripColor(String.format("%s %s", this.getPrefix(), message))
        );
    }
}
