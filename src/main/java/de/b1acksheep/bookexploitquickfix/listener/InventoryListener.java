package de.b1acksheep.bookexploitquickfix.listener;

import de.b1acksheep.bookexploitquickfix.BookExploitQuickFixPluign;
import de.b1acksheep.bookexploitquickfix.model.ExploitBook;
import net.minecraft.server.v1_8_R2.ItemStack;
import net.minecraft.server.v1_8_R2.NBTTagCompound;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.craftbukkit.v1_8_R2.inventory.CraftItemStack;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerInteractEvent;

import java.util.Date;

/**
 * Created by B1acksheep on 12.04.15.
 * Project: BookExploitQuickFix
 * Package: de.b1acksheep.bookexploitquickfix.listener
 */
public class InventoryListener implements Listener {

    private final BookExploitQuickFixPluign plugin;

    public InventoryListener(BookExploitQuickFixPluign plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onPlayerInteract(PlayerInteractEvent e) {
        if (eventContainsBook(e)) {
            e.getPlayer().sendMessage(plugin.getPrefix() + "Dieses Buch enthält " + ChatColor.BOLD + ChatColor.RED + "Schädliche Befehle.\n" +
                    ChatColor.RESET + plugin.getPrefix() + "Daher kannst du es nicht öffnen.");
            e.getPlayer().closeInventory();
            e.getPlayer().updateInventory();
            e.setCancelled(true);
        }

    }

    private boolean eventContainsBook(PlayerInteractEvent event) {
        if (event.hasItem()) {
            if (event.getItem().getType().equals(Material.WRITTEN_BOOK))
            {
                ItemStack stack = CraftItemStack.asNMSCopy(event.getPlayer().getItemInHand());
                if (!stack.hasTag()) {
                    return false;
                }
                NBTTagCompound tag = stack.getTag();
                if (tag.toString().contains("run_command")) {
                    if (event.getPlayer().hasPermission("bookexploit.admin")) {
                        event.getPlayer().sendMessage(plugin.getPrefix() + "Inhalt:\n" +
                                ChatColor.stripColor(tag.toString()));
                    }


                    ExploitBook book = new ExploitBook();
                    book.setPlayerUUID(event.getPlayer().getUniqueId().toString());
                    book.setTimeStamp(new Date());
                    book.setContentTag(tag.toString());
                    book.save();

                    event.getPlayer().getInventory().remove(event.getPlayer().getItemInHand());
                    return true;
                }
                return false;
            }
        }

        return false;
    }

}
